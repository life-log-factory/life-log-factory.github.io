<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠ - BREMONS</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .stage-type-label { font-size: 10px; background: #555; padding: 2px 5px; border-radius: 3px; margin-right: 5px; }
        .type-planet { background: #27ae60; color: #fff; } 
        .type-flight { background: #2980b9; color: #fff; } 
        .hidden { display: none !important; }

        .stage-list { margin-top: 10px; padding-right: 5px; position: relative; } /* position relativeè¿½åŠ  */
        .stage-panel { margin-bottom: 15px; border-width: 2px; border-style: solid; transition: all 0.3s; position: relative; }
        .panel-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #aaa; }
        .panel-content-wrapper { display: flex; align-items: center; justify-content: space-between; }
        .panel-text-info { flex-grow: 1; }
        .stage-name { font-size: 20px; margin-bottom: 5px; font-weight: bold; }
        .stage-info, .cost-info { font-size: 12px; color: #ccc; }
        .owned-info { font-size: 14px; color: #fff; text-align: right; margin-top:5px; font-weight:bold; }

        .progress-area { margin-top: 5px; }
        .progress-text { font-size: 10px; color: #3498db; text-align: right; }
        .progress-bar-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        .progress-bar-fill { height: 100%; background: #3498db; border-radius: 2px; width: 0%; }

        .training-btn {
            display: block; margin: 0 auto 20px auto;
            background: #2c3e50; color: #3498db; border: 2px solid #3498db;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-family: 'DotGothic16', sans-serif; font-size: 16px;
            width: 90%; text-align: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }
        .training-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 rgba(0,0,0,0.5); }

        .locked {
            background-color: rgba(0, 0, 0, 0.8) !important;
            border-color: #333 !important;
            color: #444 !important;
            pointer-events: none !important;
            opacity: 0.6 !important;
        }
        .locked .hologram-img { opacity: 0 !important; } 
        .locked .stage-status { display: none; }

        .unlocked {
            background-color: rgba(30, 30, 30, 0.9);
            border-color: #888;
            color: #fff;
            cursor: pointer;
        }

        .current { 
            border-color: #f1c40f !important;
            background: linear-gradient(to right, rgba(60, 50, 0, 0.9), rgba(0,0,0,0.8)) !important;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.3) !important;
        }
        .current .stage-status { 
            color: #000 !important;
            background-color: #f1c40f !important;
            border: none !important;
            padding: 2px 8px; border-radius: 4px;
            font-weight: bold;
            animation: blink 1s infinite alternate; 
        }

        .cleared {
            border-color: #2ecc71 !important;
            box-shadow: none !important;
        }
        .cleared .stage-status {
            color: #2ecc71 !important;
            border: 1px solid #2ecc71 !important;
            background: none !important;
            animation: none !important;
        }

        .insufficient {
            background: rgba(40, 10, 10, 0.95) !important; 
            border-color: #e74c3c !important; 
            color: #aaa !important; 
            pointer-events: none !important; 
            box-shadow: none !important; 
        }
        .insufficient .stage-name { color: #e74c3c !important; }
        .insufficient .stage-status { 
            color: #fff !important; 
            background-color: #e74c3c !important;
            border: none !important;
            animation: none !important;
            padding: 2px 8px; border-radius: 4px;
        }
        .insufficient .cost-info { color: #e74c3c !important; font-weight: bold; }

        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }

        /* --- ä¸–ç•Œè¦³ã‚’å£Šã•ãªã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ --- */
        .system-msg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 20, 40, 0.9); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .system-msg-box {
            background: #000; border: 2px solid #3498db; border-radius: 8px;
            padding: 30px; width: 85%; max-width: 400px; text-align: center;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5);
            animation: slideIn 0.3s ease-out;
        }
        .system-msg-title {
            color: #3498db; font-size: 18px; font-weight: bold; margin-bottom: 15px;
            border-bottom: 1px solid #3498db; padding-bottom: 5px;
            text-shadow: 0 0 5px #3498db;
        }
        .system-msg-text {
            color: #fff; font-size: 14px; line-height: 1.6; margin-bottom: 25px;
        }
        .system-btn {
            background: #3498db; color: #fff; border: none; padding: 12px 30px;
            font-family: inherit; font-size: 16px; cursor: pointer;
            box-shadow: 0 4px 0 #1f618d; border-radius: 4px;
        }
        .system-btn:active {
            transform: translateY(2px); box-shadow: 0 2px 0 #1f618d;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* --- â˜…è¿½åŠ : ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¹ãå‡ºã— --- */
        .guide-bubble {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #2ecc71;
            border-radius: 8px;
            padding: 10px 15px;
            width: 200px;
            z-index: 50;
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
            animation: floatBubble 2s infinite ease-in-out;
            pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é‚ªé­”ã—ãªã„ */
            
            /* åˆæœŸä½ç½®ï¼ˆJSã§åˆ¶å¾¡ã—ã¾ã™ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼‰ */
            right: 10px; 
            top: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* å¹ãå‡ºã—ã®ã—ã£ã½ï¼ˆå·¦å‘ãï¼‰ */
        .guide-bubble::after {
            content: ''; position: absolute;
            top: 50%; right: 100%; margin-top: -8px;
            border-width: 8px; border-style: solid;
            border-color: transparent #2ecc71 transparent transparent;
        }

        .guide-text {
            color: #fff; font-size: 12px; line-height: 1.4; text-align: left;
        }
        .guide-icon {
            width: 32px; height: 32px; image-rendering: pixelated;
            border-radius: 50%; border: 1px solid #fff; background: #222;
        }

        @keyframes floatBubble {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(-5px); }
        }

        /* Custom Dialog */
        .custom-dialog-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            display: flex; justify-content: center; align-items: center;
        }
        .custom-dialog-box {
            background: #222; border: 2px solid #fff; padding: 20px;
            text-align: center; border-radius: 8px; width: 80%; max-width: 300px;
            color: #fff;
        }
        .dialog-msg { margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
        .dialog-btns { display: flex; gap: 10px; justify-content: center; }
        .dialog-btn {
            padding: 8px 20px; border: 1px solid #fff; cursor: pointer;
            font-family: inherit; font-size: 14px;
        }
        .btn-yes { background: #e74c3c; color: #fff; }
        .btn-no { background: #555; color: #fff; }

    </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop autoplay></audio>

    <div class="game-container stage-select-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer" id="floatingLayer"></div>
        
        <div class="ui-layer">
            <div class="title-area" style="margin-top: 20px;">
                <h1 class="game-title" style="font-size: 32px;">BREMONS</h1>
            </div>

            <header class="stage-select-header">
                <button onclick="location.href='index.html'" class="pixel-btn back-btn">â†æˆ»ã‚‹</button>
                <h2 class="screen-title">ãƒŸãƒƒã‚·ãƒ§ãƒ³é¸æŠ</h2>
            </header>

            <button class="training-btn" onclick="location.href='training_room.html'">
                ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ (ãƒã‚¤ã‚¯èª¿æ•´)
            </button>

            <div id="loadingMsg" style="text-align:center; margin-top:10px;">ãƒ‡ãƒ¼ã‚¿ç¢ºèªä¸­...</div>

            <div id="guideBubble" class="guide-bubble hidden">
                <img src="./nightgame/chara.png" class="guide-icon">
                <div id="guideText" class="guide-text"></div>
            </div>

            <div class="stage-list hidden" id="stageList">
                <div id="panel_planet_1" class="stage-panel unlocked current" onclick="goPlanet(1)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET A</span>
                        <span class="stage-status">OPEN</span>
                    </div>
                    <div class="panel-content-wrapper">
                        <div class="hologram-container" style="color:#e74c3c;">
                            <img src="./nightgame/red.png" class="hologram-img">
                        </div>
                        <div class="panel-text-info">
                            <div class="stage-name">æƒ‘æ˜Ÿã‚¤ãƒ³ãƒãƒ¬ã‚¹</div>
                            <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Usa</div>
                            <div class="owned-info">æ‰€æŒ: <span id="count_usa" style="color:#2ecc71">0</span></div>
                        </div>
                    </div>
                </div>

                <div id="panel_flight_1" class="stage-panel locked" onclick="goFlight(1, 'usa')">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-flight">é£›è¡Œ</span>FLIGHT 1</span>
                        <span id="status_flight_1" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="panel-content-wrapper">
                        <div class="panel-text-info">
                            <div class="stage-name">ã‚¨ã‚¯ã‚»ãƒ¼ãƒ«ã¸ã®æ—…è·¯</div>
                            <div class="cost-info">å‹•åŠ›æº: Usaã®åŠ›</div>
                            <div class="progress-area">
                                <div class="progress-text">é€²æ—: <span id="prog_text_1">0</span>%</div>
                                <div class="progress-bar-bg"><div id="prog_bar_1" class="progress-bar-fill"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="panel_planet_2" class="stage-panel locked" onclick="goPlanet(2)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET B</span>
                        <span id="status_planet_2" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="panel-content-wrapper">
                        <div class="hologram-container" style="color:#3498db;">
                            <img src="./nightgame/blue.png" class="hologram-img">
                        </div>
                        <div class="panel-text-info">
                            <div class="stage-name">æƒ‘æ˜Ÿã‚¨ã‚¯ã‚»ãƒ¼ãƒ«</div>
                            <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Inv</div>
                            <div class="owned-info">æ‰€æŒ: <span id="count_inv" style="color:#2ecc71">0</span></div>
                        </div>
                    </div>
                </div>

                <div id="panel_flight_2" class="stage-panel locked" onclick="goFlight(2, 'inv')">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-flight">é£›è¡Œ</span>FLIGHT 2</span>
                        <span id="status_flight_2" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="panel-content-wrapper">
                        <div class="panel-text-info">
                            <div class="stage-name">ãƒ—ãƒã‚¦ãƒã¸ã®æ—…è·¯</div>
                            <div class="cost-info">å‹•åŠ›æº: Invã®åŠ›</div>
                            <div class="progress-area">
                                <div class="progress-text">é€²æ—: <span id="prog_text_2">0</span>%</div>
                                <div class="progress-bar-bg"><div id="prog_bar_2" class="progress-bar-fill"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                 <div id="panel_planet_3" class="stage-panel locked" onclick="goPlanet(3)">
                    <div class="panel-header">
                        <span><span class="stage-type-label type-planet">æ¢ç´¢</span>PLANET C</span>
                        <span id="status_planet_3" class="stage-status">ğŸ”’</span>
                    </div>
                    <div class="panel-content-wrapper">
                        <div class="hologram-container" style="color:#f1c40f;">
                            <img src="./nightgame/yellow.png" class="hologram-img">
                        </div>
                        <div class="panel-text-info">
                            <div class="stage-name">æƒ‘æ˜Ÿãƒ—ãƒã‚¦ãƒ</div>
                            <div class="stage-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Him</div>
                            <div class="owned-info">æ‰€æŒ: <span id="count_him" style="color:#2ecc71">0</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="width: 90%; border-top: 1px solid #555; margin: 20px 0;"></div>

            <div class="mode-card" style="border-color: #8e44ad; background: rgba(20, 0, 30, 0.8);">
                <span class="mode-title" style="color: #d2b4de;">æœªçŸ¥ã®æƒ‘æ˜Ÿã¸</span>
                <span class="mode-desc">æ–°ç¨®ã®ç”Ÿå‘½ä½“ã‚’å‰µé€ ãƒ»è¨˜éŒ²ã™ã‚‹</span>
                <button onclick="location.href='genesis_hub.html'" class="pixel-btn start-btn" 
                        style="font-size:16px; background:#8e44ad; color:#fff; animation: none;">
                    GENESIS ã¸ç§»å‹•
                </button>
            </div>
            
            <footer class="footer-area" style="margin-top: auto;">
                <div class="version">Ver ---</div>
            </footer>
        </div>
        
        <div id="confirmDialog" class="custom-dialog-overlay hidden">
            <div class="custom-dialog-box">
                <p id="confirmMsg" class="dialog-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <div class="dialog-btns">
                    <button id="btnYes" class="dialog-btn btn-yes">ã¯ã„</button>
                    <button id="btnNo" class="dialog-btn btn-no">ã„ã„ãˆ</button>
                </div>
            </div>
        </div>
        <div id="alertDialog" class="custom-dialog-overlay hidden">
            <div class="custom-dialog-box">
                <p id="alertMsg" class="dialog-msg">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
                <button onclick="closeAlert()" class="dialog-btn btn-no">OK</button>
            </div>
        </div>
    </div>

    <div id="setupMsgOverlay" class="system-msg-overlay hidden">
        <div class="system-msg-box">
            <div class="system-msg-title">SYSTEM ALERT</div>
            <div class="system-msg-text">
                ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆèªè¨¼ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>
                åˆå›èµ·å‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™ã€‚<br><br>
                ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã¸ç§»å‹•ã—ã€<br>ãƒã‚¤ã‚¯æ„Ÿåº¦èª¿æ•´ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
            </div>
            <button id="goToCockpitBtn" class="system-btn">ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã¸ç§»å‹•</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem('user_uid');
        if(!uid) location.href = 'index.html';

        let inventory = { usa: 0, inv: 0, him: 0 };
        const GOALS = { 1: 100000000, 2: 150000000, 3: 300000000 };

        async function init() {
            // 1. è¨­å®šãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
            let isConfigValid = false;
            const savedConfig = localStorage.getItem('mic_config_v2');
            
            if (savedConfig) {
                try {
                    const parsed = JSON.parse(savedConfig);
                    if (parsed && parsed.noiseThreshold !== undefined) {
                        isConfigValid = true;
                    }
                } catch (e) { console.error("è¨­å®šãƒ‡ãƒ¼ã‚¿ç ´æ"); }
            }
            
            if (!isConfigValid) {
                const overlay = document.getElementById('setupMsgOverlay');
                const btn = document.getElementById('goToCockpitBtn');
                if (overlay && btn) {
                    overlay.classList.remove('hidden');
                    btn.onclick = () => location.href = "training_room.html";
                } else {
                    alert("ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆèªè¨¼ãŒå¿…è¦ã§ã™ã€‚ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã¸ç§»å‹•ã—ã¾ã™ã€‚");
                    location.href = "training_room.html";
                }
                return;
            }

            try {
                const userRef = doc(db, "users", uid);
                const userSnap = await getDoc(userRef);
                if(userSnap.exists()) {
                    const data = userSnap.data();
                    inventory = data.inventory || { usa: 0, inv: 0, him: 0 };
                }
                document.getElementById('count_usa').innerText = inventory.usa || 0;
                document.getElementById('count_inv').innerText = inventory.inv || 0;
                document.getElementById('count_him').innerText = inventory.him || 0;

                const s1Ref = doc(db, "users", uid, "stages", "stage_1");
                const s1Snap = await getDoc(s1Ref);
                const s1Dist = s1Snap.exists() ? (s1Snap.data().totalDistance || 0) : 0;

                const s2Ref = doc(db, "users", uid, "stages", "stage_2");
                const s2Snap = await getDoc(s2Ref);
                const s2Dist = s2Snap.exists() ? (s2Snap.data().totalDistance || 0) : 0;

                updateProgress(1, s1Dist);
                updateProgress(2, s2Dist);

                const f1Unlocked = s1Dist >= GOALS[1];
                unlock("panel_flight_1", "status_flight_1", f1Unlocked);
                checkCost("panel_flight_1", "usa");

                if(f1Unlocked) {
                    unlock("panel_planet_2", "status_planet_2", false);
                    const f2Unlocked = s2Dist >= GOALS[2];
                    unlock("panel_flight_2", "status_flight_2", f2Unlocked);
                    checkCost("panel_flight_2", "inv");
                }

                if(s2Dist >= GOALS[2]) {
                    unlock("panel_planet_3", "status_planet_3", false);
                }

                document.getElementById('loadingMsg').classList.add('hidden');
                document.getElementById('stageList').classList.remove('hidden');

                // â˜…è¿½åŠ : ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
                showGuide(s1Dist, s2Dist);

            } catch(e) { console.error(e); }
        }

        // â˜…è¿½åŠ : ã‚¬ã‚¤ãƒ‰è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
        function showGuide(s1Dist, s2Dist) {
            const guide = document.getElementById('guideBubble');
            const text = document.getElementById('guideText');
            let targetId = null;
            let msg = "";

            // æ¡ä»¶åˆ†å²ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ±ºå®š
            if (inventory.usa < 1 && s1Dist < GOALS[1]) {
                targetId = 'panel_planet_1';
                msg = "ã¾ãšã¯ã“ã“ã§<br>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼(Usa)ã‚’æ•ç²ã—ã‚ˆã†ï¼";
            } 
            else if (s1Dist < GOALS[1]) {
                targetId = 'panel_flight_1';
                msg = "Usaã®åŠ›ã‚’å€Ÿã‚Šã¦<br>æ¬¡ã®æƒ‘æ˜Ÿã¸å‡ºç™ºã ï¼";
            }
            else if (inventory.inv < 1 && s2Dist < GOALS[2]) {
                targetId = 'panel_planet_2';
                msg = "åˆ°ç€ï¼æ¬¡ã¯ã“ã“ã§<br>Invã‚’é›†ã‚ã‚ˆã†ï¼";
            }
            else if (s2Dist < GOALS[2]) {
                targetId = 'panel_flight_2';
                msg = "Invã®åŠ›ãªã‚‰<br>ã‚‚ã£ã¨é ãã¸è¡Œã‘ã‚‹ã¯ãšï¼";
            }
            else if (inventory.him < 1) {
                targetId = 'panel_planet_3';
                msg = "ã¤ã„ã«ã“ã“ã¾ã§æ¥ãŸ...<br>Himã‚’ä»²é–“ã«ã—ã‚ˆã†ï¼";
            }

            if (targetId && msg) {
                text.innerHTML = msg;
                guide.classList.remove('hidden');
                
                // ä½ç½®åˆã‚ã›ï¼ˆãƒ‘ãƒãƒ«ã®å³å´ã«é…ç½®ï¼‰
                const target = document.getElementById(targetId);
                // ãƒªã‚¹ãƒˆã«å¯¾ã™ã‚‹ç›¸å¯¾ä½ç½®è¨ˆç®—ã¯CSSã®flex/gridã ã¨é›£ã—ã„ã®ã§
                // ã‚·ãƒ³ãƒ—ãƒ«ã«DOMãƒ„ãƒªãƒ¼å†…ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¦ç´ ã®ã€Œä¸­ã€ã«å¹ãå‡ºã—ã‚’ç§»å‹•ã•ã›ã‚‹
                // ã“ã‚Œãªã‚‰ position: absolute; right: 10px; ãŒåŠ¹ã
                target.appendChild(guide);
                
                // ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ï¼ˆãƒ‘ãƒãƒ«ã®ä¸­ã«å…¥ã‚Œã‚‹ã®ã§ä½ç½®ãƒªã‚»ãƒƒãƒˆï¼‰
                guide.style.right = "10px";
                guide.style.top = "50%";
                guide.style.transform = "translateY(-50%)";
                guide.style.animation = "floatBubble 2s infinite ease-in-out";
            }
        }

        function updateProgress(num, dist) {
            const goal = GOALS[num];
            let percent = Math.floor((dist / goal) * 100);
            if(percent > 100) percent = 100;
            document.getElementById(`prog_text_${num}`).innerText = percent;
            document.getElementById(`prog_bar_${num}`).style.width = percent + "%";
        }

        function unlock(panelId, statusId, isCleared) {
            const p = document.getElementById(panelId);
            const s = document.getElementById(statusId);
            if(!p) return;
            p.classList.remove('locked');
            p.classList.add('unlocked');
            if(isCleared) {
                p.classList.add('cleared');
                s.innerText = "COMPLETE";
            } else {
                p.classList.add('current');
                s.innerText = "GO!";
            }
        }

        function checkCost(panelId, monsterId) {
            const p = document.getElementById(panelId);
            if(p.classList.contains('locked')) return;
            const count = inventory[monsterId] || 0;
            if(count < 1) {
                p.classList.add('insufficient');
                p.querySelector('.stage-status').innerText = "âš ï¸æ¢ç´¢å¿…è¦"; 
            }
        }

        init();

        window.goPlanet = function(n) {
            if(document.getElementById(`panel_planet_${n}`).classList.contains('locked')) return;
            window.location.href = `planet_game.html?planet=${n}`;
        };

        window.goFlight = function(n, monsterId) {
            const p = document.getElementById(`panel_flight_${n}`);
            if(p.classList.contains('locked')) return;
            if(p.classList.contains('insufficient')) return;
            
            showConfirm(`ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼(${monsterId})ã®åŠ›ã‚’å€Ÿã‚Šã¦å‡ºç™ºã—ã¾ã™ã‹ï¼Ÿ`, () => {
                window.location.href = `game_main.html?stage=${n}&cost=${monsterId}`;
            });
        };

        function showConfirm(msg, onYes) {
            const dialog = document.getElementById('confirmDialog');
            document.getElementById('confirmMsg').innerText = msg;
            dialog.classList.remove('hidden');
            document.getElementById('btnYes').onclick = () => { dialog.classList.add('hidden'); onYes(); };
            document.getElementById('btnNo').onclick = () => { dialog.classList.add('hidden'); };
        }
        window.closeAlert = function() { document.getElementById('alertDialog').classList.add('hidden'); };
        
        document.body.addEventListener('click', function() {
            var bgm = document.getElementById('bgm');
            if(bgm.paused) bgm.play();
        }, { once: true });
        
    </script>
    <script src="script.js"></script>
</body>
</html>