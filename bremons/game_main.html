<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BREMONS Mission</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .game-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 50px; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .stage-title-display { font-size: 16px; text-shadow: 2px 2px 0 #000; color: #fff; }
        .pause-btn { background: rgba(0,0,0,0.5); border: 2px solid #fff; border-radius: 5px; font-size: 20px; color: #fff; cursor: pointer; text-shadow: 2px 2px 0 #000; width: 40px; height: 40px; }
        .info-panel { margin-top: 50px; }
        .rocket { bottom: 220px !important; }
        .hidden { display: none !important; }
        .pause-modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .pause-content { background: #fff; color: #333; padding: 30px; border-radius: 10px; text-align: center; width: 80%; border: 4px solid #333; }
        .pause-warning { font-size: 12px; color: #e74c3c; margin-top: 5px; font-weight: bold; }
        .result-inventory { font-size: 14px; margin: 10px 0; color: #2ecc71; font-weight: bold; }
        /* --- ãŠç¥ã„æ¼”å‡ºç”¨CSS --- */
        .celebration-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .cel-text {
            font-size: 40px; color: #f1c40f; font-weight: bold; margin-bottom: 30px;
            text-shadow: 0 0 10px #e74c3c;
            animation: zoomIn 0.5s ease-out;
        }
        .monsters-party {
            display: flex; gap: 20px; margin-bottom: 40px;
        }
        .cel-monster {
            width: 60px; height: auto; image-rendering: pixelated;
            animation: jump 0.6s infinite alternate;
        }
        .cel-monster:nth-child(2) { animation-delay: 0.2s; } /* ãšã‚‰ã—ã¦è·³ã­ã•ã›ã‚‹ */
        .cel-monster:nth-child(3) { animation-delay: 0.4s; }

        @keyframes jump {
            from { transform: translateY(0) rotate(-10deg); }
            to { transform: translateY(-30px) rotate(10deg); }
        }
        @keyframes zoomIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tactical-guide {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px;
            text-align: center; color: #fff; font-weight: bold;
            text-shadow: 2px 2px 0 #000; pointer-events: none; z-index: 90;
            animation: pulseGuide 1s infinite alternate;
        }
        .guide-big { font-size: 48px; color: #f1c40f; display: block; margin: 10px 0; }
        .guide-sub { font-size: 18px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 4px; }

        @keyframes pulseGuide {
            from { transform: translate(-50%, -50%) scale(1); }
            to { transform: translate(-50%, -50%) scale(1.05); }
        }
    </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop></audio>

    <div class="game-container game-screen">
        <div class="scrolling-bg speed-stop" id="gameBg"></div>
        
        <header class="game-header" id="gameHeader">
            <div class="stage-title-display" id="stageNameDisplay">LOADING...</div>
            <button class="pause-btn" onclick="togglePause()">||</button>
        </header>
        
        <div class="game-layer" id="gameLayer">
            <div id="rocket" class="rocket">
                <img src="./nightgame/rocket.png" alt="rocket">
                <img src="./nightgame/smoke.png" class="rocket-smoke" id="smoke">
                <img src="./nightgame/chara.png" class="pilot" alt="pilot">
            </div>
        </div>

        <div class="map-container">
            <div class="planet-goal">â˜…</div>
            <div class="map-rail">
                <div class="map-marker" id="mapMarker">ğŸš€</div>
            </div>
            <div class="planet-start">â—</div>
        </div>

        <div class="ui-layer game-ui">
            <div class="info-panel">
                <div class="distance-meter">ã‚ã¨: <span id="remainDist">---</span> km</div>
                <div class="fuel-meter">
                    ç‡ƒæ–™: <span id="fuelTime">0.00</span> ç§’åˆ†
                    <div class="fuel-bar-container"><div class="fuel-bar" id="fuelBar"></div></div>
                </div>
            </div>

            <div id="messageArea" class="message-area">
                <p>ã‚¨ãƒãƒ«ã‚®ãƒ¼å……å¡«ä¸­...<br>(ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼å¾…æ©Ÿä¸­)</p>
            </div>

            <div class="control-panel">
                <div class="mic-status">
                    <div>Input Level</div>
                    <div class="mic-level-bar"><div id="micLevel"></div></div>
                </div>
                <div id="actionBtnArea">
                    <button id="paBtn" class="pixel-btn action-btn" disabled>ã±ã£ï¼(ç™ºå°„)</button>
                </div>
            </div>
        </div>
        
        <div id="countdownOverlay" class="countdown-layer hidden">
            <div id="countdownText">3</div>
        </div>

        <div id="tacticalGuide" class="tactical-guide hidden">
            <span class="guide-sub">æº–å‚™</span>
            <span class="guide-big">æ¯ã‚’å¸ã£ã¦...</span>
        </div>

        <div id="pauseModal" class="pause-modal hidden">
            <div class="pause-content">
                <h2>PAUSE</h2>
                <div style="margin: 20px 0; color:#333; text-align:left;">
                    <p>ãƒã‚¤ã‚¯æ„Ÿåº¦ã¯ã€Œã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã€ã§<br>èª¿æ•´ã—ãŸè¨­å®šãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                </div>
                <p class="pause-warning">â€»ä¸­æ–­ã™ã‚‹ã¨ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¯æˆ»ã‚Šã¾ã›ã‚“</p>

                <div class="modal-btns">
                    <button onclick="togglePause()" class="pixel-btn start-btn">ã‚²ãƒ¼ãƒ å†é–‹</button>
                    <button onclick="location.href='stage_select.html'" class="pixel-btn">èˆªè¡Œã‚’ä¸­æ–­ã™ã‚‹</button>
                </div>
            </div>
        </div>

        <div id="resultModal" class="modal hidden">
            <div class="modal-content">
                <h2>ç‡ƒæ–™åˆ‡ã‚Œ...</h2>
                <div style="text-align: left; margin: 10px 0;">
                    <p>ä»Šå›ã®é£›è¡Œ: <span id="resultDist" style="color:#f1c40f">0</span> km</p>
                    <p>ç¾åœ¨ã®åœ°ç‚¹: <span id="totalDistDisplay">0</span> km</p>
                </div>
                <div class="result-inventory">æ‰€æŒ: <span id="currentStock">?</span> åŒ¹</div>
                
                <div class="modal-btns">
                    <button id="retryBtn" onclick="tryRetry()" class="pixel-btn start-btn">åŠ›ã‚’å€Ÿã‚Šã¦å†å‡ºç™º</button>
                    <button onclick="location.href='stage_select.html'" class="pixel-btn">ä¸€æ™‚æ’¤é€€ã™ã‚‹</button>
                </div>
            </div>
        </div>
        <div id="celebrationOverlay" class="celebration-overlay hidden">
            <div class="cel-text">GOAL!!</div>
            <div class="monsters-party">
                <img src="./nightgame/blue.png" class="cel-monster">
                <img src="./nightgame/red.png" class="cel-monster">
                <img src="./nightgame/yellow.png" class="cel-monster">
            </div>
            <div style="color:#fff; margin-bottom:20px;">ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼</div>
            <button onclick="location.href='stage_select.html'" class="pixel-btn start-btn">å¸°é‚„ã™ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem('user_uid');
        if(!uid) { location.href = "index.html"; }

        window.DB = {};

        window.DB.load = async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stageNum = urlParams.get('stage') || 1;
            const docRef = doc(db, "users", uid, "stages", `stage_${stageNum}`);
            const docSnap = await getDoc(docRef);
            return docSnap.exists() ? (docSnap.data().totalDistance || 0) : 0;
        };

        window.DB.getInventoryCount = async (costId) => {
            if(!costId) return 0;
            const userRef = doc(db, "users", uid);
            const snap = await getDoc(userRef);
            if(snap.exists() && snap.data().inventory) {
                return snap.data().inventory[costId] || 0;
            }
            return 0;
        };

        window.DB.consumeAndStart = async (costId) => {
            const userRef = doc(db, "users", uid);
            const updateField = {};
            updateField[`inventory.${costId}`] = increment(-1);
            try {
                await updateDoc(userRef, updateField);
                window.readyToStart = true;
                return true;
            } catch(e) {
                console.error(e);
                alert("ã‚¨ãƒ©ãƒ¼: é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ");
                location.href = "stage_select.html";
                return false;
            }
        };

        window.DB.save = async (logData, totalDistance) => {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const stageNum = urlParams.get('stage') || 1;
                const stageRef = doc(db, "users", uid, "stages", `stage_${stageNum}`);
                const userRef = doc(db, "users", uid);

                const thisFlightDist = logData.distance;
                const thisFuelTime = logData.fuelDuration;

                const userSnap = await getDoc(userRef);
                const userData = userSnap.exists() ? userSnap.data() : {};
                
                const newMaxDist = Math.max(userData.maxSingleFlight || 0, thisFlightDist);
                const newMaxFuel = Math.max(userData.maxFuelDuration || 0, thisFuelTime);
                
                await setDoc(userRef, { 
                    lastLogin: new Date().toISOString(),
                    displayName: localStorage.getItem('user_name') || "åç„¡ã—",
                    maxSingleFlight: newMaxDist,
                    maxFuelDuration: newMaxFuel,
                    totalGlobalDistance: increment(thisFlightDist)
                }, { merge: true });

                await setDoc(stageRef, {
                    totalDistance: totalDistance,
                    history: arrayUnion(logData)
                }, { merge: true });

            } catch (e) {
                console.error("Save Error:", e);
            }
        };
    </script>

    <script src="game_script.js"></script>
    <script src="script.js"></script> 
</body>
</html>