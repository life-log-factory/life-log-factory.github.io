<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calibration Room</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* コックピット専用レイアウト */
        .cockpit-ui {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; height: 100%; padding: 10px; box-sizing: border-box;
            z-index: 10; position: relative;
        }

        /* モニター風枠 */
        .monitor-frame {
            width: 95%; max-width: 500px; height: 140px;
            background: #000; border: 4px solid #555; border-radius: 4px;
            box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.1);
            margin: 10px 0; position: relative; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; opacity: 0.9; }
        .monitor-frame::after {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 5;
        }

        /* 検出インジケーターランプ */
        .indicator-panel {
            display: flex; gap: 20px; margin-bottom: 15px;
        }
        .lamp {
            width: 80px; height: 40px; background: #222; border: 3px solid #444;
            color: #555; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold; border-radius: 4px;
            transition: 0.1s;
        }
        .lamp.active-ha {
            background: #e67e22; color: #fff; border-color: #fff;
            box-shadow: 0 0 20px #e67e22; transform: scale(1.1);
        }
        .lamp.active-pa {
            background: #3498db; color: #fff; border-color: #fff;
            box-shadow: 0 0 20px #3498db; transform: scale(1.1);
        }

        /* ステップバー */
        .step-bar {
            display: flex; gap: 5px; width: 95%; max-width: 500px; margin-bottom: 5px;
        }
        .step-dot {
            flex: 1; background: #333; border: 2px solid #555; color: #777;
            text-align: center; padding: 5px 0; font-size: 12px;
        }
        .step-dot.active { background: #e67e22; color: #fff; border-color: #fff; box-shadow: 0 0 8px #e67e22; }
        .step-dot.done { background: #27ae60; color: #fff; border-color: #2ecc71; }

        /* ガイドメッセージ */
        .msg-box {
            width: 95%; max-width: 500px;
            background: rgba(0, 0, 0, 0.7); border: 2px solid #fff;
            padding: 15px; margin-bottom: 10px; min-height: 70px;
            text-align: left; font-size: 14px; line-height: 1.6;
        }
        .highlight { color: #f1c40f; font-weight: bold; font-size: 16px; border-bottom: 1px dashed #f1c40f; }
        .error-text { color: #e74c3c; font-weight: bold; animation: flash 1s infinite; }
        @keyframes flash { 50% { opacity: 0.5; } }

        /* 操作エリア */
        .action-container {
            width: 95%; max-width: 500px; flex-grow: 1;
            display: flex; flex-direction: column; justify-content: flex-start; gap: 10px;
        }
        .big-btn { width: 100%; padding: 20px; font-size: 18px; border-width: 4px; margin-bottom: 10px; }
        .recording { background: #27ae60 !important; color: #fff !important; pointer-events: none; border-color: #fff !important; }

        /* 進捗バー */
        .progress-frame {
            width: 100%; height: 16px; border: 2px solid #fff; padding: 2px;
            display: none; box-sizing: border-box;
        }
        .progress-bar { width: 0%; height: 100%; background: #27ae60; transition: width 2s linear; }

        /* オーバーレイ */
        .retro-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .retro-box {
            border: 4px double #fff; background: #000; padding: 20px; width: 85%; max-width: 400px; text-align: center;
        }
    </style>
</head>
<body>

    <div class="game-container menu-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer"></div>

        <div class="cockpit-ui">
            <header class="stage-select-header" style="width:100%; max-width:500px;">
                <button onclick="location.href='stage_select.html'" class="pixel-btn back-btn">←戻る</button>
                <h2 class="screen-title">コックピット</h2>
            </header>

            <div class="step-bar">
                <div id="step1" class="step-dot">1.静寂</div>
                <div id="step2" class="step-dot">2.はっ！</div>
                <div id="step3" class="step-dot">3.ぱっ！</div>
            </div>

            <div class="monitor-frame">
                <canvas id="visCanvas"></canvas>
            </div>

            <div class="indicator-panel">
                <div id="lampHa" class="lamp">HA</div>
                <div id="lampPa" class="lamp">PA</div>
            </div>

            <div class="msg-box">
                <div id="guideText">システム起動中...</div>
            </div>

            <div class="action-container">
                <button id="actionBtn" class="pixel-btn big-btn" onclick="executeStep()">待機中...</button>
                
                <div id="progressContainer" class="progress-frame">
                    <div id="progressFill" class="progress-bar"></div>
                </div>

                <div id="finishMenu" style="display:none; width:100%; gap:10px; flex-direction:column;">
                    <p style="color:#2ecc71; text-align:center; margin:0;">調整完了！<br>「はっ」「ぱっ」と発声して<br>上のランプが光るか確認してください。</p>
                    
                    <button onclick="location.href='stage_select.html'" class="pixel-btn start-btn" style="width:100%;">調整完了！</button>
                    <button onclick="resetCalibration()" class="pixel-btn" style="width:100%; background:#555;">最初からやり直す</button>
                </div>
            </div>
        </div>
    </div>

    <div id="introOverlay" class="retro-overlay">
        <div class="retro-box">
            <h2 style="color:#3498db; margin-top:0;">ようこそ、パイロット</h2>
            <p style="text-align:left; font-size:14px; line-height:1.8; margin-bottom:20px;">
                あなたの「声」を動力として登録します。<br>
                3つのステップで感度を調整します。<br>
                準備ができたら開始してください。
            </p>
            <button class="pixel-btn start-btn" onclick="startTutorial()">調整を開始する</button>
        </div>
    </div>

    <script>
        let audioContext, analyser, dataArray, canvas, ctx;
        const LOW_FREQ_IDX = 24;
        let currentStep = 0; 
        let calibBuffer = [];
        let config = { noiseThreshold: 0.05, haProfile: null, paProfile: null };
        let cooldown = 0;

        window.onload = () => {
            const saved = localStorage.getItem('mic_config_v2');
            if (saved) {
                document.getElementById('introOverlay').classList.add('hidden');
                try { config = JSON.parse(saved); } catch(e){}
                setStep(4); // 完了状態へ
                initAudio();
            }
        };

        function startTutorial() {
            document.getElementById('introOverlay').classList.add('hidden');
            initAudio();
            setStep(1);
        }

        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const mic = audioContext.createMediaStreamSource(stream);
                mic.connect(analyser);
                analyser.fftSize = 1024;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                canvas = document.getElementById('visCanvas');
                ctx = canvas.getContext('2d');
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
                
                loop();
            } catch(e) {
                document.getElementById('guideText').innerHTML = "<span class='error-text'>エラー：マイクの使用を許可してください。</span>";
            }
        }

        function resizeCanvas() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
        }

        function setStep(step, retryMessage = null) {
            currentStep = step;
            const btn = document.getElementById('actionBtn');
            const guide = document.getElementById('guideText');

            [1,2,3].forEach(i => {
                const el = document.getElementById(`step${i}`);
                el.className = 'step-dot'; 
                if (i < step) el.classList.add('done');
                if (i === step) el.classList.add('active');
            });

            if (step <= 3) {
                btn.style.display = 'block';
                btn.className = 'pixel-btn big-btn';
                btn.style.background = ''; 
                document.getElementById('finishMenu').style.display = 'none';
            }

            // エラーメッセージがあればそれを優先表示
            if (retryMessage) {
                guide.innerHTML = retryMessage;
            } else {
                switch(step) {
                    case 1:
                        guide.innerHTML = "ステップ1：<span class='highlight'>環境ノイズの測定</span><br>部屋の静けさを測ります。<br>ボタンを押して2秒間、静かにしてください。";
                        btn.innerText = "計測開始 (静かに)";
                        break;
                    case 2:
                        guide.innerHTML = "ステップ2：<span class='highlight'>「はっ」の登録</span><br>攻撃アクションに使用します。<br>ボタンを押し、「はっ！」と鋭く息を吐いてください。";
                        btn.innerText = "録音開始 (はっ！)";
                        break;
                    case 3:
                        guide.innerHTML = "ステップ3：<span class='highlight'>「ぱっ」の登録</span><br>防御バリアに使用します。<br>ボタンを押し、「ぱっ！」と発音してください。";
                        btn.innerText = "録音開始 (ぱっ！)";
                        break;
                    case 4: 
                        guide.innerHTML = "設定完了！<br>マイクに向かって発声し、ランプの反応を確認してください。<br>問題なければ出撃可能です。";
                        btn.style.display = 'none';
                        document.getElementById('finishMenu').style.display = 'flex';
                        localStorage.setItem('mic_config_v2', JSON.stringify(config));
                        break;
                }
            }
        }

        function executeStep() {
            if (!audioContext) return;
            const btn = document.getElementById('actionBtn');
            const progressBg = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');

            btn.classList.add('recording');
            btn.innerText = "計測中...";
            progressBg.style.display = 'block';
            
            progressFill.style.transition = 'none';
            progressFill.style.width = '0%';
            setTimeout(() => {
                progressFill.style.transition = 'width 2s linear';
                progressFill.style.width = '100%';
            }, 10);

            calibBuffer = [];
            const interval = setInterval(() => {
                const frame = [];
                for(let i=0; i<LOW_FREQ_IDX; i++) frame.push(dataArray[i] / 255.0);
                calibBuffer.push(frame);
            }, 50);

            setTimeout(() => {
                clearInterval(interval);
                finishRecording();
            }, 2000);
        }

        function finishRecording() {
            const btn = document.getElementById('actionBtn');
            const progressBg = document.getElementById('progressContainer');
            btn.classList.remove('recording');
            progressBg.style.display = 'none';

            if (currentStep === 1) { 
                let maxNoise = 0;
                calibBuffer.forEach(frame => {
                    const m = Math.max(...frame);
                    if(m > maxNoise) maxNoise = m;
                });
                config.noiseThreshold = Math.min(maxNoise + 0.05, 0.4);
                setStep(2);
            } 
            else if (currentStep === 2 || currentStep === 3) {
                let peakFrame = null;
                let maxVol = -1;
                calibBuffer.forEach(frame => {
                    const vol = frame.reduce((a,b)=>a+b, 0);
                    if (vol > maxVol) { maxVol = vol; peakFrame = frame; }
                });

                if (maxVol > 0.3) {
                    if (currentStep === 2) config.haProfile = peakFrame;
                    if (currentStep === 3) config.paProfile = peakFrame;
                    setStep(currentStep + 1);
                } else {
                    // ★alertを使わず、ガイドメッセージでエラーを表示してリトライ
                    const errorMsg = "<span class='error-text'>エラー：音が小さすぎました。</span><br>マイクに近づいて、もう一度大きく発音してください。";
                    setStep(currentStep, errorMsg);
                }
            }
        }

        function resetCalibration() {
            // ★confirmを使わず、即座にステップ1へ戻る
            setStep(1);
        }

        function loop() {
            requestAnimationFrame(loop);
            if (!analyser) return;
            analyser.getByteFrequencyData(dataArray);

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const barW = (canvas.width / LOW_FREQ_IDX) * 0.8;
            let x = 0;
            for(let i=0; i<LOW_FREQ_IDX; i++) {
                const val = dataArray[i] / 255.0;
                let color = '#3498db'; 
                if (val > config.noiseThreshold) color = '#2ecc71'; 
                if (currentStep > 3) { 
                    if(config.haProfile) {
                        const h = config.haProfile[i] * canvas.height;
                        ctx.fillStyle = 'rgba(230, 126, 34, 0.2)';
                        ctx.fillRect(x, canvas.height - h, barW, h);
                    }
                }
                ctx.fillStyle = color;
                const h = val * canvas.height;
                ctx.fillRect(x, canvas.height - h, barW, h);
                x += barW + 2;
            }
            const noiseY = canvas.height * (1 - config.noiseThreshold);
            ctx.strokeStyle = '#777';
            ctx.setLineDash([5, 5]);
            ctx.beginPath(); ctx.moveTo(0, noiseY); ctx.lineTo(canvas.width, noiseY); ctx.stroke(); ctx.setLineDash([]);

            if (currentStep === 4 && cooldown <= 0) {
                checkVoice();
            }
            if (cooldown > 0) cooldown--;
        }

        function checkVoice() {
            let maxAmp = 0;
            for(let i=0; i<LOW_FREQ_IDX; i++) if(dataArray[i]/255.0 > maxAmp) maxAmp = dataArray[i]/255.0;
            if (maxAmp < config.noiseThreshold) return;

            let haDist = 0, paDist = 0;
            for(let i=0; i<LOW_FREQ_IDX; i++) {
                const val = dataArray[i] / 255.0;
                haDist += Math.pow(config.haProfile[i] - val, 2);
                paDist += Math.pow(config.paProfile[i] - val, 2);
            }
            const haScore = 1/(1+Math.sqrt(haDist));
            const paScore = 1/(1+Math.sqrt(paDist));

            if (haScore > 0.65 && haScore > paScore) {
                lightUp('lampHa', 'active-ha');
            } else if (paScore > 0.65 && paScore > haScore) {
                lightUp('lampPa', 'active-pa');
            }
        }

        function lightUp(id, cls) {
            const el = document.getElementById(id);
            el.classList.add(cls);
            cooldown = 10; 
            setTimeout(() => el.classList.remove(cls), 200);
        }
    </script>
</body>
</html>