<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GENESIS - BREMONS</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* === 裏モード専用スタイル === */
        body {
            margin: 0; padding: 0;
            font-family: 'DotGothic16', sans-serif;
            background-color: #050505; color: #fff;
            display: flex; justify-content: center;
            height: 100dvh; overflow: hidden;
            user-select: none;
        }

        .game-container {
            width: 100%; max-width: 480px; height: 100%;
            position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(142, 68, 173, 0.2);
            display: flex; flex-direction: column;
        }

        .scrolling-bg {
            position: absolute; top: -50%; left: 0; width: 100%; height: 200%;
            background-image: url('./nightgame/background2.png');
            background-size: cover; background-repeat: repeat-y;
            z-index: 0;
            animation: scrollSpace 60s linear infinite;
            filter: contrast(1.1) brightness(0.8);
        }
        @keyframes scrollSpace { from { transform: translateY(0); } to { transform: translateY(50%); } }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            padding: 10px; box-sizing: border-box;
            background: rgba(0, 0, 0, 0.4);
        }

        .back-link {
            position: absolute; top: 15px; left: 15px;
            font-size: 14px; text-decoration: none; color: #fff;
            background: rgba(0,0,0,0.8); padding: 8px 15px;
            border: 1px solid #fff; border-radius: 4px;
        }

        .title-area { margin-top: 50px; text-align: center; margin-bottom: 30px; }
        .game-title {
            font-size: 52px; margin: 0; letter-spacing: 2px;
            background: linear-gradient(to right, #ff9a9e, #4facfe, #f093fb);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            filter: drop-shadow(4px 4px 0px rgba(255, 255, 255, 0.2));
            animation: title-glitch 5s infinite;
        }
        @keyframes title-glitch {
            0%, 95% { transform: skew(0deg); } 96% { transform: skew(10deg); } 97% { transform: skew(-10deg); } 98% { transform: skew(0deg); }
        }
        .subtitle { font-size: 16px; color: #fff; margin-top: 5px; letter-spacing: 5px; opacity: 0.8; }

        .menu-list { width: 90%; display: flex; flex-direction: column; gap: 20px; }
        .hub-btn {
            font-family: 'DotGothic16', sans-serif; font-size: 24px; padding: 25px 0; width: 100%;
            background-color: rgba(20, 0, 30, 0.85); color: #fff;
            border: 2px solid #8e44ad; border-radius: 8px;
            cursor: pointer; text-align: center;
            box-shadow: 0 0 10px rgba(142, 68, 173, 0.3);
            transition: all 0.2s; display: flex; justify-content: center; align-items: center;
        }
        .hub-btn:hover { background-color: #8e44ad; box-shadow: 0 0 20px rgba(142, 68, 173, 0.8); transform: scale(1.02); }

        .status-bar {
            margin-top: auto; margin-bottom: 30px; font-size: 14px; color: #aaa;
            border-top: 1px solid #555; padding-top: 15px; width: 90%; text-align: center;
        }

        .pokedex-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 10, 0.98); z-index: 100;
            display: flex; flex-direction: column; align-items: center; padding-top: 20px;
        }
        .pokedex-header { width: 90%; text-align: center; border-bottom: 2px solid #8e44ad; padding-bottom: 10px; margin-bottom: 10px; }
        .pokedex-title { color: #f093fb; font-size: 28px; letter-spacing: 3px; }
        
        .pokedex-scroll-area { width: 95%; flex: 1; overflow-y: auto; padding: 5px; display: flex; flex-direction: column; gap: 20px; }
        .section-label { color: #8e44ad; border-bottom: 1px solid #333; font-size: 14px; margin-bottom: 10px; padding-left: 5px; }
        .pokedex-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
        .pokedex-item {
            background: #151515; border: 1px solid #444; border-radius: 6px; padding: 5px; text-align: center;
            position: relative; transition: border-color 0.2s; cursor: pointer;
        }
        .pokedex-item:hover { border-color: #f1c40f; background: #222; }
        .pokedex-canvas { width: 100%; height: auto; image-rendering: pixelated; }
        .pokedex-name { font-size: 10px; color: #888; margin-top: 4px; overflow: hidden; white-space: nowrap; }
        
        .count-badge {
            position: absolute; top: -5px; right: -5px; background: #e74c3c; color: #fff;
            font-size: 10px; font-weight: bold; padding: 2px 5px; border-radius: 10px;
            border: 1px solid #fff; box-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
        .original-mon { border: 1px solid #f1c40f; background: rgba(241, 196, 15, 0.1); box-shadow: 0 0 8px rgba(241, 196, 15, 0.2); }
        .close-btn {
            margin: 20px 0; background: #333; color: #fff; border: 2px solid #fff; padding: 15px 40px; cursor: pointer;
            font-family: 'DotGothic16', sans-serif; font-size: 18px; border-radius: 8px;
        }
        .close-btn:hover { background: #555; }

        /* 詳細モーダル */
        #detailModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 150;
            display: flex; justify-content: center; align-items: center;
        }
        .detail-card {
            background: #1a0b2e; border: 2px solid #8e44ad; border-radius: 8px;
            padding: 20px; width: 80%; max-width: 300px; text-align: center;
            box-shadow: 0 0 20px rgba(142, 68, 173, 0.5);
        }
        .detail-info { text-align: left; margin-top: 15px; font-size: 12px; color: #ccc; line-height: 1.6; }
        .detail-label { color: #f093fb; font-weight: bold; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="scrolling-bg"></div>
        <div class="ui-layer">
            <a href="stage_select.html" class="back-link">←戻る</a>
            <div class="title-area"><h1 class="game-title">BREMONS</h1><span class="subtitle">- GENESIS -</span></div>
            <div class="menu-list">
                <button onclick="location.href='monster_maker.html'" class="hub-btn">モンスターを生成</button>
                <button onclick="location.href='bgm_maker.html'" class="hub-btn">BGMを生成(ベータ版)</button>
                <button onclick="location.href='genesis_exploration.html'" class="hub-btn">未知の惑星を探索</button>
                <button onclick="openPokedex()" class="hub-btn" style="background: rgba(0, 50, 20, 0.8); border-color:#2ecc71;">図鑑</button>
            </div>
            <div class="status-bar">
                <div style="margin-bottom:5px;">GENESIS STORAGE</div>
                <div style="color:#f093fb; font-size:18px;">登録総数: <span id="savedCount">---</span> 体</div>
            </div>
        </div>

        <div id="pokedexModal" class="pokedex-overlay hidden">
            <div class="pokedex-header"><div class="pokedex-title">図鑑</div></div>
            <div class="pokedex-scroll-area">
                <div>
                    <div class="section-label">初期モンスター</div>
                    <div id="gridOriginal" class="pokedex-grid" style="grid-template-columns: repeat(3, 1fr);"></div>
                </div>
                <div>
                    <div class="section-label">捕獲・生成モンスター</div>
                    <div id="gridUser" class="pokedex-grid"></div>
                </div>
            </div>
            <button onclick="document.getElementById('pokedexModal').classList.add('hidden')" class="close-btn">閉じる</button>
        </div>

        <div id="detailModal" class="hidden">
            <div class="detail-card">
                <h3 style="margin-top:0; color:#f093fb;">DNAデータ詳細</h3>
                <div style="display:flex; justify-content:center; margin:10px 0;">
                    <canvas id="detailCanvas" width="100" height="100" style="width:100px; height:100px; image-rendering:pixelated; background:#000; border:1px solid #555;"></canvas>
                </div>
                <div class="detail-info">
                    <div><span class="detail-label">CODE:</span> <span id="detCode"></span></div>
                    <div><span class="detail-label">生成者:</span> <span id="detCreator"></span></div>
                    <div><span class="detail-label">生成日時:</span> <br><span id="detGenDate"></span></div>
                    <div><span class="detail-label">捕獲日時:</span> <br><span id="detCaughtDate"></span></div>
                </div>
                <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="pixel-btn" style="margin-top:15px; font-size:14px; padding:10px;">閉じる</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem('user_uid');

        let myMonsters = [];
        let caughtMonsters = [];
        let groupedData = {};

        async function init() {
            if(!uid) return;
            try {
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                if(snap.exists()) {
                    const data = snap.data();
                    myMonsters = data.genesisMonsters || [];
                    caughtMonsters = data.genesisCaught || [];
                    const allCodes = new Set([...myMonsters.map(m => m.code), ...caughtMonsters.map(m => m.code)]);
                    document.getElementById('savedCount').innerText = allCodes.size;
                }
            } catch(e) { console.error(e); }
        }

        window.openPokedex = function() {
            const gridOrig = document.getElementById('gridOriginal');
            const gridUser = document.getElementById('gridUser');
            gridOrig.innerHTML = ""; gridUser.innerHTML = ""; 

            addPokedexItem(gridOrig, "./nightgame/red.png", "Usa", null);
            addPokedexItem(gridOrig, "./nightgame/blue.png", "Inv", null);
            addPokedexItem(gridOrig, "./nightgame/yellow.png", "Him", null);

            groupedData = {};
            
            // 生成データを統合
            myMonsters.forEach(m => {
                if(!groupedData[m.code]) groupedData[m.code] = { count: 0, code: m.code, genDate: m.createdAt, creator: "自分" };
                groupedData[m.code].count++;
            });
            // 捕獲データを統合
            caughtMonsters.forEach(m => {
                if(!groupedData[m.code]) groupedData[m.code] = { count: 0, code: m.code, creator: m.creator, caughtDate: m.caughtAt };
                else {
                    groupedData[m.code].count++;
                    if(!groupedData[m.code].caughtDate) groupedData[m.code].caughtDate = m.caughtAt;
                    if(groupedData[m.code].creator === "自分" && m.creator && m.creator !== "自分") {
                        // 自分が作ったものを捕獲した場合の表示優先などは要調整だが、基本は「自分」のままでOK
                    } else if(!groupedData[m.code].creator) {
                        groupedData[m.code].creator = m.creator;
                    }
                }
            });

            const uniqueCodes = Object.keys(groupedData);
            if(uniqueCodes.length === 0) {
                gridUser.innerHTML = "<div style='grid-column:1/-1; color:#555; text-align:center; padding:20px;'>データなし</div>";
            } else {
                uniqueCodes.forEach(code => {
                    const item = groupedData[code];
                    const div = document.createElement('div');
                    div.className = 'pokedex-item new-mon';
                    div.onclick = () => showDetail(code); // 詳細表示イベント
                    
                    const cvs = document.createElement('canvas');
                    cvs.width = 20; cvs.height = 20; cvs.className = 'pokedex-canvas';
                    drawFromCode(cvs, code);

                    const name = document.createElement('div');
                    name.className = 'pokedex-name'; name.innerText = code;

                    div.appendChild(cvs); div.appendChild(name);
                    if(item.count > 1) {
                        const badge = document.createElement('div'); badge.className = 'count-badge'; badge.innerText = "×" + item.count;
                        div.appendChild(badge);
                    }
                    gridUser.appendChild(div);
                });
            }
            document.getElementById('pokedexModal').classList.remove('hidden');
        };

        window.showDetail = function(code) {
            const data = groupedData[code];
            if(!data) return;

            document.getElementById('detCode').innerText = data.code;
            document.getElementById('detCreator').innerText = data.creator || "不明";
            document.getElementById('detGenDate').innerText = data.genDate ? new Date(data.genDate).toLocaleString() : "---";
            document.getElementById('detCaughtDate').innerText = data.caughtDate ? new Date(data.caughtDate).toLocaleString() : "---";

            const cvs = document.getElementById('detailCanvas');
            const ctx = cvs.getContext('2d');
            // 大きく描画するためにスケール
            ctx.clearRect(0,0,100,100);
            ctx.save();
            ctx.scale(5, 5); // 20x20 -> 100x100
            drawFromCode(cvs, code);
            ctx.restore();

            document.getElementById('detailModal').classList.remove('hidden');
        };

        function addPokedexItem(grid, src, label, code) {
            const div = document.createElement('div');
            div.className = 'pokedex-item ' + (code ? 'new-mon' : 'original-mon');
            const img = document.createElement('img'); img.src = src; img.className = 'pokedex-canvas';
            const name = document.createElement('div'); name.className = 'pokedex-name'; name.innerText = label;
            div.appendChild(img); div.appendChild(name);
            grid.appendChild(div);
        }

        init();

        const SCALE_COLORS = [
            { hex: "#FF9AA2", eye: "#C85A62" }, { hex: "#FFB7B2", eye: "#D67C77" },
            { hex: "#FFDAC1", eye: "#D4A88F" }, { hex: "#FFE6A7", eye: "#C9B475" },
            { hex: "#FFF5BA", eye: "#C4BD87" }, { hex: "#C1E1C1", eye: "#8FAB8F" },
            { hex: "#B2E0E6", eye: "#81ADB3" }, { hex: "#AEEEEE", eye: "#7FBDBD" },
            { hex: "#ADD8E6", eye: "#7FA8B6" }, { hex: "#B4C6E7", eye: "#8396B7" },
            { hex: "#C3B1E1", eye: "#917FB1" }, { hex: "#E6B0AA", eye: "#B37D77" }
        ];
        function drawFromCode(canvas, code) {
            if(!code) return; const ctx = canvas.getContext('2d'); const parts = code.split('-'); 
            if(parts.length < 3) return;
            let raw = parts[1] + parts[2]; 
            const p1 = parseInt(raw.substring(0,2), 16); const p2 = parseInt(raw.substring(2,4), 16);
            const p3 = parseInt(raw.substring(4,6), 16); const p4 = parseInt(raw.substring(6,8), 16);
            drawMonster(ctx, p1, p2, p3, p4);
        }
        function drawMonster(ctx, noteIdx, pitchVal, typeVal, rndVal) {
            const colorData = SCALE_COLORS[noteIdx % 12]; const mainColor = colorData.hex; const eyeColor = colorData.eye;
            const shadowColor = adjustBrightness(mainColor, -25); const outlineColor = adjustBrightness(mainColor, -40);
            // ctx.clearRectは呼び出し元で行う場合もあるが、ここでも入れておく(scale影響に注意)
            // scaleされている場合があるのでclearRectは使わず上書き描画のみにするか、呼び出し元でclearする
            // 今回は上書き前提
            const masterSeed = (noteIdx << 24) ^ (pitchVal << 16) ^ (typeVal << 8) ^ rndVal; const rng = new Xorshift32(masterSeed);
            const gridSize = 20; const grid = Array(gridSize).fill(0).map(() => Array(gridSize).fill(0));
            const centerX = 9.5; const centerY = 10.5; let squash = 0.7 + (pitchVal / 255) * 0.3;
            const baseRadiusW = 8.0; const baseRadiusH = 8.0 * squash;
            for (let y = 0; y < gridSize; y++) for (let x = 0; x < gridSize; x++) { const dx = x - centerX; const dy = y - centerY; let dynamicRadiusW = baseRadiusW * (1.0 + dy * 0.04); if ((dx*dx)/(dynamicRadiusW*dynamicRadiusW) + (dy*dy)/(baseRadiusH*baseRadiusH) <= 0.95) grid[y][x] = 2; }
            const partsType = Math.floor(rng.next() * 4); 
            let bodyTopY = 0; for(let y=0; y<gridSize/2; y++) { if(grid[y][9] === 2) { bodyTopY = y; break; } }
            const earX = Math.floor(centerX - 2); const earBaseY = bodyTopY;
            if (earBaseY >= 1) { if (partsType === 0) { grid[earBaseY][earX]=2; grid[earBaseY][earX-1]=2; grid[earBaseY-1][earX]=2; grid[earBaseY-1][earX-1]=2; grid[earBaseY][earX-1]=4; } else if (partsType === 1) { grid[earBaseY-1][earX]=2; grid[earBaseY-2][earX]=2; grid[earBaseY-1][earX]=4; } else if (partsType === 2) { grid[earBaseY][earX-1]=2; grid[earBaseY-1][earX-1]=2; grid[earBaseY-1][earX-2]=2; grid[earBaseY][earX-1]=4; } }
            let bodyBottomY = gridSize-1; for(let y=gridSize-1; y>gridSize/2; y--) { if(grid[y][9] === 2) { bodyBottomY = y; break; } }
            const legX = Math.floor(centerX - 3); if (bodyBottomY < gridSize-1 && rng.next() > 0.3) { grid[bodyBottomY+1][legX] = 2; grid[bodyBottomY+2][legX] = 1; grid[bodyBottomY+1][legX-1] = 2; grid[bodyBottomY+2][legX-1] = 1; }
            for (let y=0; y<gridSize; y++) for(let x=0; x<10; x++) if(grid[y][x]!==0) grid[y][19-x]=grid[y][x];
            const finalGrid = JSON.parse(JSON.stringify(grid)); for (let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) if(grid[y][x]===2 || grid[y][x]===4) { let isEdge=false; [[0,-1],[0,1],[-1,0],[1,0]].forEach(([nx,ny])=>{if(!grid[y+ny]||grid[y+ny][x+nx]===0)isEdge=true;}); if(isEdge)finalGrid[y][x]=1; }
            for (let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) if(finalGrid[y][x]===2) { if(x>centerX+4 && y>centerY+3 && (x+y)%2===0) finalGrid[y][x]=4; }
            for (let y=0; y<gridSize; y++) for(let x=0; x<gridSize; x++) { const val=finalGrid[y][x]; if(val!==0){ if(val===1)ctx.fillStyle=outlineColor; else if(val===2)ctx.fillStyle=mainColor; else if(val===4)ctx.fillStyle=shadowColor; ctx.fillRect(x,y,1,1); } }
            const eyeY = Math.floor(centerY); const eyeX_L = 6; const eyeX_R = 12; let eyePattern = typeVal % 3;
            drawSpecifiedEye(ctx, eyeX_L, eyeY, eyeColor, shadowColor, eyePattern); drawSpecifiedEye(ctx, eyeX_R, eyeY, eyeColor, shadowColor, eyePattern, false);
        }
        function drawSpecifiedEye(ctx, x, y, color, shadow, pattern, isRight=false) {
            ctx.fillStyle = "#fff"; if (pattern === 0) { ctx.fillRect(x, y, 2, 2); ctx.fillStyle = color; ctx.fillRect(x, y+2, 2, 2); } else if (pattern === 1) { ctx.fillRect(x, y, 2, 2); ctx.fillStyle = shadow; ctx.fillRect(x, y+2, 2, 1); ctx.fillStyle = color; ctx.fillRect(x, y+3, 2, 1); } else { ctx.fillRect(x, y, 2, 2); ctx.fillStyle = shadow; ctx.fillRect(x, y+2, 2, 1); ctx.fillStyle = color; ctx.fillRect(x, y+3, 2, 1); const decoX = x + 2; ctx.fillStyle = shadow; ctx.fillRect(decoX, y+2, 1, 1); ctx.fillStyle = color; ctx.fillRect(decoX, y+1, 1, 1); }
        }
        class Xorshift32 { constructor(seed) { this.state = seed | 0; if (this.state === 0) this.state = 0xdeadbeef; } next() { let x = this.state; x ^= x << 13; x ^= x >>> 17; x ^= x << 5; this.state = x; return (x >>> 0) / 4294967296; } }
        function adjustBrightness(hex, p) { let r = parseInt(hex.slice(1,3), 16); let g = parseInt(hex.slice(3,5), 16); let b = parseInt(hex.slice(5,7), 16); r = Math.max(0, Math.min(255, r + Math.round(2.55 * p))); g = Math.max(0, Math.min(255, g + Math.round(2.55 * p))); b = Math.max(0, Math.min(255, b + Math.round(2.55 * p))); return "#" + (1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1); }
    </script>
</body>
</html>