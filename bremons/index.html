<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BREMONS</title>
    <link rel="manifest" href="manifest.json">
    
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style> .hidden { display: none !important; } </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop></audio>
    <div class="game-container menu-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer" id="floatingLayer"></div>

        <div class="ui-layer">
            <div class="title-area">
                <h1 class="game-title">BREMONS</h1>
                <span class="subtitle">- ブレモンズ -</span>
            </div>

            <div id="loginArea" class="menu-list">
                <p>パイロット認証が必要です</p>
                <button id="loginBtn" class="pixel-btn start-btn">Googleでログイン</button>
                <button id="guestLoginBtn" class="pixel-btn" style="margin-top:10px; background:#e67e22;">ゲストで始める</button>
            </div>

            <nav id="menuArea" class="menu-list hidden">
                <p>ようこそ、宇宙飛行士<span id="userName" style="color:#f1c40f;">パイロット</span></p>
                <button onclick="startGame()" class="pixel-btn start-btn">ゲームスタート</button>
                <button onclick="location.href='log_view.html'" class="pixel-btn">軌跡をみる(グラフ)</button>
                
                <div style="display:flex; gap:10px; width:100%;">
                    <button onclick="location.href='ranking.html'" class="pixel-btn" style="flex:1; font-size:14px;">ランキング</button>
                    <button onclick="location.href='battle_select.html'" class="pixel-btn" style="flex:1; font-size:14px; background:#e67e22; color:#fff;">対戦</button>
                </div>

                <button id="logoutBtn" class="pixel-btn" style="font-size:14px; background:#555;">ログアウト</button>
                
                <button id="installBtn" class="pixel-btn" style="display:none; background:#3498db; margin-top:10px; font-weight:bold;">
                    アプリをインストール
                </button>

                <button id="resetDataBtn" class="pixel-btn" style="font-size:12px; background:#e74c3c; margin-top:20px;">⚠️ 自分のデータをリセット</button>
            </nav>
            
            <footer class="footer-area">
                <div class="version">Ver ---</div>
            </footer>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // ★下の行に signInWithRedirect, getRedirectResult を追加しました
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, writeBatch, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const loginArea = document.getElementById('loginArea');
        const menuArea = document.getElementById('menuArea');
        const loginBtn = document.getElementById('loginBtn');
        const guestLoginBtn = document.getElementById('guestLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userNameSpan = document.getElementById('userName');

        // ★スマホかどうかの判定機能
        const isMobile = () => {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            return /android|ipad|iphone|ipod/i.test(userAgent);
        };

        // ★ログインボタンの処理を修正
        loginBtn.addEventListener('click', () => {
            if (isMobile()) {
                // スマホの場合：リダイレクト（画面遷移）でログイン
                // ※Android Chromeではこれが最も確実です
                signInWithRedirect(auth, provider);
            } else {
                // PCの場合：今まで通りポップアップ
                signInWithPopup(auth, provider).catch((error) => alert("ログイン失敗: " + error.message));
            }
        });

        // ★リダイレクトから戻ってきた時の処理（スマホ用）
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    // リダイレクト成功時の処理は onAuthStateChanged が検知するので、
                    // ここでは特別な処理は不要ですが、エラーハンドリングのために記述しています
                    console.log("スマホログイン成功");
                }
            })
            .catch((error) => {
                console.error("スマホログイン失敗:", error);
                alert("ログインに失敗しました: " + error.message);
            });

        guestLoginBtn.addEventListener('click', () => {
            signInAnonymously(auth)
                .catch((error) => {
                    console.error("ゲストログイン失敗:", error);
                    alert("ゲストログインに失敗しました");
                });
        });

        logoutBtn.addEventListener('click', () => { signOut(auth); });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginArea.classList.add('hidden');
                menuArea.classList.remove('hidden');
                userNameSpan.innerText = user.displayName || "名無しパイロット";
                localStorage.setItem('user_uid', user.uid);
                localStorage.setItem('user_name', user.displayName);
            } else {
                loginArea.classList.remove('hidden');
                menuArea.classList.add('hidden');
                localStorage.removeItem('user_uid');
            }
        });
        
        window.startGame = function() { window.location.href = "stage_select.html"; };
        window.goBattle = function() { alert("リアルタイム対戦は開発中です！"); };

        document.addEventListener('DOMContentLoaded', () => {
            const bgm = document.getElementById('bgm');
            // エラー回避のためbgmが存在するか確認
            if(bgm) {
                bgm.volume = 0.3;
                bgm.play().catch(() => {});
                document.body.addEventListener('click', () => { if (bgm.paused) bgm.play(); }, { once: true });
            }
        });

        document.getElementById('resetDataBtn').addEventListener('click', async () => {
            const uid = localStorage.getItem('user_uid');
            if (!uid) return;
            if (!confirm("本当に自分のデータを全て初期化しますか？\n（ランキングや所持数も0になります）")) return;
            const btn = document.getElementById('resetDataBtn');
            btn.innerText = "削除中...";
            btn.disabled = true;
            try {
                const batch = writeBatch(db);
                const userRef = doc(db, "users", uid);
                batch.set(userRef, {
                    displayName: localStorage.getItem('user_name'),
                    lastLogin: new Date().toISOString(),
                    inventory: { usa: 0, inv: 0, him: 0 },
                    totalGlobalDistance: 0,
                    maxSingleFlight: 0,
                    maxFuelDuration: 0,
                    totalStars: 0,
                    totalBlueStars: 0
                });
                const stagesRef = collection(db, "users", uid, "stages");
                const snapshot = await getDocs(stagesRef);
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                alert("リセット完了しました！");
                btn.innerText = "⚠️ 自分のデータをリセット";
                btn.disabled = false;
            } catch (e) {
                console.error(e);
                alert("エラーが発生しました: " + e.message);
                btn.disabled = false;
            }
        });
    </script>
    
    <script src="script.js"></script>
    
    <script>
        // Service Workerの登録
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(function(registration) {
                    console.log('Service Worker Registered');
                })
                .catch(function(error) {
                    console.log('Service Worker Registration Failed');
                });
        }

        // インストールボタンの制御
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Chrome 67以前では自動的にプロンプトが出ないようにする
            e.preventDefault();
            // イベントを保持しておく
            deferredPrompt = e;
            // インストールボタンを表示
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', (e) => {
            // ボタンを隠す
            installBtn.style.display = 'none';
            // プロンプトを表示
            deferredPrompt.prompt();
            // ユーザーが応答した後の処理
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the A2HS prompt');
                } else {
                    console.log('User dismissed the A2HS prompt');
                }
                deferredPrompt = null;
            });
        });
    </script>
</body>
</html>