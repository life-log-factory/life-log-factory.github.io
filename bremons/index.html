<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BREMONS</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style> 
        .hidden { display: none !important; } 
        
        /* モーダル用スタイル */
        .modal-input {
            font-family: 'DotGothic16', sans-serif;
            font-size: 18px;
            padding: 10px;
            width: 80%;
            margin: 15px 0;
            text-align: center;
            background: #eee;
            border: 2px solid #333;
            border-radius: 4px;
        }

        /* システムログ */
        #systemLog {
            position: absolute; top: -60px; left: 0; width: 100%; height: 50px;
            background: rgba(0, 20, 0, 0.95); border-bottom: 2px solid #2ecc71;
            color: #2ecc71; display: flex; align-items: center; justify-content: center;
            z-index: 9999; font-size: 14px;
            transition: top 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        #systemLog.show { top: 0; }
    </style>
</head>
<body>
    <audio id="bgm" src="./bgm/GuideToAdventure.mp3" loop></audio>
    
    <div class="game-container menu-screen">
        <div class="scrolling-bg"></div>
        <div class="floating-layer" id="floatingLayer"></div>

        <div id="systemLog">
            <span id="systemLogText">SYSTEM READY...</span>
        </div>

        <div class="ui-layer">

            <div id="reviewGuide" class="guide-bubble arrow-right hidden" style="top: 15px; right: 150px;">
                <img src="./nightgame/chara.png" class="guide-icon">
                <div class="guide-text">評価してね！</div>
            </div>

            <button id="reviewBtn" onclick="location.href='review.html'" class="pixel-btn top-left-btn hidden">
                ★ 評価
            </button>

            <button id="openSettingsBtn" class="pixel-btn top-right-btn hidden">
                設定
            </button>

            <div class="title-area">
                <h1 class="game-title">BREMONS</h1>
                <span class="subtitle">- ブレモンズ -</span>
            </div>

            <div id="loginArea" class="menu-list">
                <p>パイロット認証が必要です</p>
                <button id="loginBtn" class="pixel-btn start-btn">Googleでログイン</button>
                <button id="guestLoginBtn" class="pixel-btn" style="margin-top:10px; background:#e67e22;">ゲストで始める</button>
            </div>

            <nav id="menuArea" class="menu-list hidden">
                <p>ようこそ、<br><span id="userTitleWrapper" style="color:#f1c40f; font-size:18px; font-weight:bold;"></span></p>
                
                <button onclick="startGame()" class="pixel-btn start-btn">ゲームスタート</button>
                <button onclick="location.href='log_view.html'" class="pixel-btn">軌跡をみる(グラフ)</button>
                
                <div style="display:flex; gap:10px; width:100%;">
                    <button onclick="location.href='ranking.html'" class="pixel-btn" style="flex:1; font-size:14px;">ランキング</button>
                    <button onclick="location.href='battle_select.html'" class="pixel-btn" style="flex:1; font-size:14px; background:#e67e22; color:#fff;">対戦</button>
                </div>

                <button id="logoutBtn" class="pixel-btn" style="font-size:14px; background:#555;">ログアウト</button>
                
                <button id="installBtn" class="pixel-btn" style="display:none; background:#3498db; margin-top:10px; font-weight:bold;">
                    アプリをインストール
                </button>

                <button id="resetDataBtn" class="pixel-btn" style="font-size:12px; background:#e74c3c; margin-top:20px;">[!] 自分のデータをリセット</button>
            </nav>
            
            <footer class="footer-area">
                <div class="version">Ver 6.4.5</div>
            </footer>
        </div>

        <div id="guestNameModal" class="modal hidden">
            <div class="modal-content">
                <h3>パイロット登録</h3>
                <p>ランキングに表示される<br>コールサインを入力</p>
                <input type="text" id="guestNameInput" class="modal-input" placeholder="NAME" maxlength="8">
                <p style="font-size:12px; color:#e67e22;">※自動で「体験飛行士」が付与されます</p>
                <div class="modal-btns">
                    <button id="saveGuestNameBtn" class="pixel-btn" style="background:#2ecc71; color:white;">登録承認</button>
                </div>
            </div>
        </div>

        <div id="settingsModal" class="modal hidden">
            <div class="modal-content">
                <h3>システム設定</h3>
                <p>表示名の書き換え</p>
                <input type="text" id="settingsNameInput" class="modal-input" placeholder="NEW NAME" maxlength="12">
                <div class="modal-btns">
                    <button id="saveSettingsBtn" class="pixel-btn" style="background:#2ecc71; color:white;">データ更新</button>
                    <button id="closeSettingsBtn" class="pixel-btn" style="background:#95a5a6;">キャンセル</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithRedirect, getRedirectResult, signInAnonymously, GoogleAuthProvider, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, writeBatch, collection, getDocs, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUWMn07YntLyB8m4q5-zHmiwjYOz1c_nk",
            authDomain: "bremons.firebaseapp.com",
            projectId: "bremons",
            storageBucket: "bremons.firebasestorage.app",
            messagingSenderId: "30413071482",
            appId: "1:30413071482:web:f62c34349b13e6c6ce47c3",
            measurementId: "G-4D4FCXGDBG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        const loginArea = document.getElementById('loginArea');
        const menuArea = document.getElementById('menuArea');
        const userTitleWrapper = document.getElementById('userTitleWrapper');
        const loginBtn = document.getElementById('loginBtn');
        const guestLoginBtn = document.getElementById('guestLoginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const openSettingsBtn = document.getElementById('openSettingsBtn');
        // ★追加: 評価ボタンの参照
        const reviewBtn = document.getElementById('reviewBtn');
        
        const guestNameModal = document.getElementById('guestNameModal');
        const guestNameInput = document.getElementById('guestNameInput');
        const saveGuestNameBtn = document.getElementById('saveGuestNameBtn');

        const settingsModal = document.getElementById('settingsModal');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const settingsNameInput = document.getElementById('settingsNameInput');

        function showSystemMessage(msg) {
            const logBox = document.getElementById('systemLog');
            const logText = document.getElementById('systemLogText');
            logText.innerText = ">> " + msg;
            logBox.classList.add('show');
            setTimeout(() => { logBox.classList.remove('show'); }, 3000);
        }

        const isMobile = () => /android|ipad|iphone|ipod/i.test(navigator.userAgent);

        // --- ログイン処理 ---
        loginBtn.addEventListener('click', () => {
            // デバイス問わずポップアップ認証に統一
            signInWithPopup(auth, provider)
                .then((result) => {
                    // ログイン成功時の処理（onAuthStateChangedが発火するので空でも良いが、念のため）
                    console.log("Login Success");
                })
                .catch((error) => {
                    console.error(error);
                    // 具体的なエラー内容を簡易表示（デバッグ用）
                    showSystemMessage("ERR: " + error.code);
                });
        });
                
        getRedirectResult(auth).catch((e) => console.error(e));

        guestLoginBtn.addEventListener('click', async () => {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("ゲストログイン失敗:", error);
                showSystemMessage("ERR: GUEST LOGIN FAILED");
            }
        });

        logoutBtn.addEventListener('click', () => { signOut(auth); });

        // --- 状態監視 ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if (user.displayName) {
                    await showMenu(user);
                } else {
                    if (user.isAnonymous) {
                        guestNameModal.classList.remove('hidden');
                        loginArea.classList.add('hidden');
                    } else {
                        showMenu(user); 
                    }
                }
            } else {
                // ログアウト状態
                loginArea.classList.remove('hidden');
                menuArea.classList.add('hidden');
                guestNameModal.classList.add('hidden');
                settingsModal.classList.add('hidden');
                openSettingsBtn.classList.add('hidden');
                // ★追加: 評価ボタンも隠す
                reviewBtn.classList.add('hidden');
                document.getElementById('reviewGuide').classList.add('hidden');
                
                localStorage.removeItem('user_uid');
            }
        });

        // --- ゲスト登録処理 ---
        saveGuestNameBtn.addEventListener('click', async () => {
            const rawName = guestNameInput.value.trim();
            if (!rawName) {
                showSystemMessage("ERR: NAME REQUIRED");
                return;
            }
            const fullName = "体験飛行士" + rawName;
            await updateUserName(fullName, "PILOT REGISTERED");
            guestNameModal.classList.add('hidden');
        });

        // --- 設定画面処理 ---
        openSettingsBtn.addEventListener('click', () => {
            settingsNameInput.value = auth.currentUser.displayName || "";
            settingsModal.classList.remove('hidden');
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
        });

        saveSettingsBtn.addEventListener('click', async () => {
            const newName = settingsNameInput.value.trim();
            if (!newName) {
                showSystemMessage("ERR: INVALID NAME");
                return;
            }
            saveSettingsBtn.innerText = "UPDATING...";
            await updateUserName(newName, "名前が変更されました");
            saveSettingsBtn.innerText = "データ更新";
            settingsModal.classList.add('hidden');
        });

        async function updateUserName(newName, successMsg) {
            const user = auth.currentUser;
            if (!user) return;
            try {
                await updateProfile(user, { displayName: newName });
                await setDoc(doc(db, "users", user.uid), {
                    displayName: newName,
                    lastLogin: new Date().toISOString()
                }, { merge: true });
                await showMenu(user);
                showSystemMessage(successMsg);
            } catch (e) {
                console.error(e);
                showSystemMessage("ERR: CONNECTION FAILED");
            }
        }

        // --- メニュー表示 ---
        async function showMenu(user) {
            loginArea.classList.add('hidden');
            menuArea.classList.remove('hidden');
            openSettingsBtn.classList.remove('hidden');
            
            // ★追加: ログイン後に評価ボタンを表示
            reviewBtn.classList.remove('hidden');
            
            const currentName = user.displayName || "UNKNOWN";
            if (user.isAnonymous) {
                userTitleWrapper.innerText = currentName;
            } else {
                userTitleWrapper.innerText = "宇宙飛行士 " + currentName;
            }
            
            localStorage.setItem('user_uid', user.uid);
            localStorage.setItem('user_name', currentName);

            // 吹き出しを少し遅れて表示
            setTimeout(() => {
                const guide = document.getElementById('reviewGuide');
                if (guide) guide.classList.remove('hidden');
            }, 1000);
        }
        
        window.startGame = function() { window.location.href = "stage_select.html"; };
        
        document.addEventListener('DOMContentLoaded', () => {
            const bgm = document.getElementById('bgm');
            if(bgm) {
                bgm.volume = 0.3;
                bgm.play().catch(() => {});
                document.body.addEventListener('click', () => { if (bgm.paused) bgm.play(); }, { once: true });
            }
        });

        // リセット処理 (省略)
        document.getElementById('resetDataBtn').addEventListener('click', async () => {
             // ...既存の処理...
        });
    </script>
    
    <script src="script.js"></script>
    
    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(() => console.log('SW Registered'));
        }
        // PWA Install
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e; installBtn.style.display = 'block';
        });
        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt = null;
        });
    </script>
</body>
</html>